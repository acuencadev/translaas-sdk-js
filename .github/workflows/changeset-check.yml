name: Changeset Check

on:
  pull_request:
    branches:
      - main

jobs:
  check-changesets:
    name: Check for Changesets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup npm cache
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Dependencies
        run: npm ci

      - name: Check for Changesets
        run: |
          # Check if there are any changes to packages
          if git diff --name-only origin/main...HEAD | grep -q "^packages/"; then
            # Check if there are any changeset files
            if ! git diff --name-only origin/main...HEAD | grep -q "^\.changeset/"; then
              echo "❌ No changeset found for package changes!"
              echo "Please create a changeset by running: npm run changeset"
              echo ""
              echo "Changed packages:"
              git diff --name-only origin/main...HEAD | grep "^packages/" | sed 's|packages/@translaas/||' | sed 's|/.*||' | sort -u
              exit 1
            else
              echo "✅ Changeset found!"
            fi
          else
            echo "ℹ️  No package changes detected, skipping changeset check"
          fi
